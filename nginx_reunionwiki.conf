# Bloc HTTP - redirige vers HTTPS
server {
    listen 80;
    server_name reunionwiki.re www.reunionwiki.re;

    # Redirection permanente vers HTTPS
    return 301 https://$host$request_uri;
}

# Bloc HTTPS avec certificat SSL (Let's Encrypt)
server {
    listen 443 ssl;
    server_name reunionwiki.re www.reunionwiki.re;

    # Chemins vers les certificats SSL
    ssl_certificate /etc/letsencrypt/live/reunionwiki.re/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/reunionwiki.re/privkey.pem;

    # Protocoles SSL autorisés
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Logs d'accès et d'erreurs
    access_log /var/log/nginx/reunionwiki_access.log;
    error_log /var/log/nginx/reunionwiki_error.log;

    # Headers de sécurité HTTP

    # Sécurité HTTPS : forcer le HTTPS sur tout le site
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Politique de sécurité du contenu (anti-XSS, anti injection)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src * data:;" always;

    # Bloque l'accès aux API sensibles du navigateur
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Empêche l'affichage du site dans une iframe (anti-clickjacking)
    add_header X-Frame-Options "SAMEORIGIN";

    # Empêche les attaques par détournement de type de contenu
    add_header X-Content-Type-Options "nosniff";

    # Contrôle ce que le navigateur envoie comme referrer
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # MODIFICATION : Healthcheck pour vérifier l'état de l'application
    location = /healthz { 
        return 200 "ok\n"; 
        add_header Content-Type text/plain;
    }

    # MODIFICATION : Configuration du proxy vers Gunicorn avec gestion d'erreurs améliorée
    location / {
        # MODIFICATION : Ajout de timeouts et retry pour éviter les erreurs 502/503/504
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # MODIFICATION : Timeouts pour éviter les erreurs de connexion
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # MODIFICATION : Retry en cas d'échec temporaire
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
    }

    # Accès aux fichiers statiques
    location ^~ /static/ {
        root /var/www/reunion-wiki-app/;
        autoindex off;
        try_files $uri =404;

        # (ajout) Forcer l'encodage UTF-8 pour éviter les warnings d'encodage
        charset utf-8;
    }

    # Désactive le CSP pour les rapports datés
    # (modifié) On garde ta logique mais on complète la CSP pour supporter les templates GoAccess + fonts embarquées
    location ~* ^/static/report-humains-[0-9\-]+\.html$ {
        root /var/www/reunion-wiki-app/;

        # (ajout) Encodage
        charset utf-8;

        # (ajout) CSP détendue pour GoAccess (autorise 'unsafe-eval' et fonts en data:)
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;" always;

        # (ajout) Éviter l'indexation par les moteurs de recherche
        add_header X-Robots-Tag "noindex, nofollow" always;

        # (on garde ta neutralisation de headers si besoin)
        add_header Permissions-Policy "" always;
        add_header X-Frame-Options "" always;
        add_header X-Content-Type-Options "" always;
    }

    # Restriction IP sur le rapport principal
    # (modifié) On ajoute la CSP détendue + noindex ici aussi pour que le rapport fonctionne même restreint
    location = /static/report-humains.html {
        root /var/www/reunion-wiki-app/;

        # (ajout) Encodage
        charset utf-8;

        allow 83.198.87.150;
        deny all;

        # (ajout) CSP détendue (sinon le rapport casse)
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;" always;

        # (ajout) Éviter l'indexation
        add_header X-Robots-Tag "noindex, nofollow" always;
    }

    # Accès au favicon
    location /favicon.ico {
        alias /var/www/reunion-wiki-app/static/favicon.ico;
    }

    # MODIFICATION : Page de maintenance - désactivée temporairement pour diagnostiquer
    # error_page 502 503 504 =200 /maintenance.html;

    # MODIFICATION : Page de maintenance avec gestion d'erreurs améliorée
    error_page 502 503 504 @maintenance;

    location @maintenance {
        # MODIFICATION : Vérification que le fichier existe avant de l'afficher
        root /var/www/reunion-wiki-app/static;
        try_files /maintenance.html =503;
        internal;
    }

    # MODIFICATION : Route explicite pour la page de maintenance (en cas de besoin manuel)
    location = /maintenance.html {
        root /var/www/reunion-wiki-app/static;
        internal;
    }

    # PWA - Service Worker
    location = /service-worker.js {
        root /var/www/reunion-wiki-app/static/;
        access_log off;
        add_header Cache-Control "no-cache";
    }

    # PWA - Manifest JSON
    location = /manifest.json {
        root /var/www/reunion-wiki-app/static/;
        access_log off;
    }

    # robots.txt pour le SEO
    location = /robots.txt {
        root /var/www/reunion-wiki-app/static/;
        access_log off;
    }

    # sitemap.xml pour les moteurs de recherche
    location = /sitemap.xml {
        root /var/www/reunion-wiki-app/static/;
        access_log off;
    }
}
