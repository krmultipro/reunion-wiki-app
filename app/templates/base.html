<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO de base: 2 blocs UNIQUES, r√©utilis√©s partout -->
    <title>
      {% block seo_title %}R√©union Wiki - Sites internet utiles de La R√©union{%
      endblock %}
    </title>
    <meta
      name="description"
      content="{% block seo_description %}Acc√©dez facilement aux sites r√©unionnais essentiels et d√©couvrez les talents de la R√©union : culture, emploi, services, transports, m√©t√©o et plus.{% endblock %}"
    />

    <!-- Canonical -->
    <link
      rel="canonical"
      href="{% block canonical %}{{ request.base_url }}{% endblock %}"
    />

    <!-- Open Graph -->
    <meta property="og:site_name" content="R√©union Wiki" />
    <meta property="og:locale" content="fr_FR" />
    <meta property="og:title" content="{{ self.seo_title() }}" />
    <meta property="og:description" content="{{ self.seo_description() }}" />
    <meta
      property="og:url"
      content="{% block og_url %}{{ request.base_url }}{% endblock %}"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="{{ url_for('static', filename='icons/icon-512x512.png', _external=True) }}"
    />
    <meta property="og:image:alt" content="Logo R√©union Wiki" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ self.seo_title() }}" />
    <meta name="twitter:description" content="{{ self.seo_description() }}" />
    <meta
      name="twitter:image"
      content="{{ url_for('static', filename='icons/icon-512x512.png', _external=True) }}"
    />

    <!-- Favicon / PWA -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <link
      rel="apple-touch-icon"
      href="{{ url_for('static', filename='icons/icon-192x192.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.webmanifest') }}"
    />
    <meta name="theme-color" content="#009688" />

    <!-- CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='bootstrap/css/bootstrap.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}?v=8"
    />

    <!-- Fonts locales -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='fonts.css') }}"
    />

    {% block head %}{% endblock %}
  </head>

  <body>
    <header>
      <h1 class="site_title"><a href="/">R√©union Wiki</a></h1>
      {% block header_content %}{% endblock %}
    </header>

    <!-- Navigation principale -->
    <nav class="main-nav">
      <button
        class="nav-search-toggle"
        aria-expanded="false"
        aria-label="Ouvrir la recherche"
      >
        üîç
      </button>
      <div class="nav-scroll" data-scrollable>
        <!-- Liste des liens -->
        <ul class="nav-links" id="main-nav-links">
          <li>
            <a
              href="{{ url_for('public.accueil') }}"
              class="{{ 'active' if request.path == url_for('public.accueil') else '' }}"
              aria-current="{{ 'page' if request.path == url_for('public.accueil') else '' }}"
            >
              Accueil
            </a>
          </li>

          {% for cat in categories %} {% set slug = categories_slug[cat] %} {%
          set cat_url = url_for('public.voir_categorie', slug=slug) %}
          <li>
            <a
              href="{{ cat_url }}"
              class="{{ 'active' if request.path.startswith(cat_url) else '' }}"
              aria-current="{{ 'page' if request.path.startswith(cat_url) else '' }}"
            >
              {{ cat }}
            </a>
          </li>
          {% endfor %}

          <li>
            <a
              href="{{ url_for('public.nouveaux_sites') }}"
              class="{{ 'active' if request.path == url_for('public.nouveaux_sites') else '' }}"
              aria-current="{{ 'page' if request.path == url_for('public.nouveaux_sites') else '' }}"
            >
              Derniers sites ajout√©s
            </a>
          </li>
          <li>
            <a
              href="{{ url_for('public.formulaire') }}"
              class="{{ 'active' if request.path == url_for('public.formulaire') else '' }}"
              aria-current="{{ 'page' if request.path == url_for('public.formulaire') else '' }}"
            >
              Proposer un site
            </a>
          </li>
          <li>
            <a
              href="{{ url_for('public.talents') }}"
              class="{{ 'active' if request.path == url_for('public.talents') else '' }}"
              aria-current="{{ 'page' if request.path == url_for('public.talents') else '' }}"
            >
              Talents
            </a>
          </li>
          <li><a href="{{ url_for('public.faq') }}">FAQ</a></li>

          <li>
            <a
              href="{{ url_for('public.blog') }}"
              class="{{ 'active' if request.path == url_for('public.blog') else '' }}"
              aria-current="{{ 'page' if request.path == url_for('public.blog') else '' }}"
            >
              Blog
            </a>
          </li>

          <li>
            <a
              href="{{ url_for('public.contact') }}"
              class="{{ 'active' if request.path == url_for('public.contact') else '' }}"
              aria-current="{{ 'page' if request.path == url_for('public.contact') else '' }}"
            >
              Contact
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <form
      class="nav-search-panel"
      action="{{ url_for('public.search') }}"
      method="get"
      role="search"
    >
      <div class="nav-search-panel__inner">
        <label class="sr-only" for="nav-search-input">Rechercher un site</label>
        <input
          id="nav-search-input"
          name="q"
          type="search"
          placeholder="Rechercher un site (ex : emploi, transport...)"
          value="{{ request.args.get('q', '') if request.endpoint == 'public.search' else '' }}"
          required
          minlength="2"
          autocomplete="off"
        />
        <button type="submit" class="btn btn-primary">Rechercher</button>
        <button
          type="button"
          class="nav-search-close"
          aria-label="Fermer la recherche"
        >
          ‚úï
        </button>
      </div>
    </form>

    <main>{% block content %}{% endblock %}</main>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %}
    <div class="flash-stack">
      {% for category, message in messages %}
      <div class="flash-message flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <footer>
      <!--<a
        href="https://forms.gle/kimeZjk8TPQAhMCE6"
        class="propos_site"
        target="__blank"
        >Proposez un site !</a
      > -->
      <p><strong>R√©union Wiki</strong> - Simplifions l'information locale.</p>
      <nav>
        <a href="{{ url_for('public.faq') }}">FAQ</a> |
        <a href="{{ url_for('public.mentions_legales') }}" target="">Mentions l√©gales</a> |
        <a href="{{ url_for('public.contact') }}">Contact</a>
      </nav>
    </footer>

    <script
      src="{{ url_for('static', filename='bootstrap/js/bootstrap.bundle.min.js') }}"
    ></script>
    <script>
      // Enregistrement du Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(() => console.log("Service Worker enregistr√©"))
          .catch((err) => console.error("Erreur Service Worker :", err));
      }

      // Si l'app est d√©j√† install√©e (mode standalone), on ne fait rien
      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches ||
        window.navigator.standalone === true;

      if (!isStandalone) {
        let deferredPrompt;

        // √âcoute de l‚Äô√©v√©nement d'installation propos√© par Chrome
        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault(); // Emp√™che Chrome d'afficher sa banni√®re native
          deferredPrompt = e;

          // Cr√©ation du bouton "Installer l'application"
          const installBtn = document.createElement("button");
          installBtn.textContent = "Installer l'application üì≤";
          installBtn.style = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 15px;
        font-weight: bold;
        font-family: 'Inter', sans-serif;
        background-color: #009688;
        color: white;
        border: none;
        border-radius: 12px;
        box-shadow: 0px 2px 5px rgba(0,0,0,0.3);
        z-index: 1000;
      `;
          document.body.appendChild(installBtn);

          //Quand l'utilisateur clique sur le bouton
          installBtn.addEventListener("click", () => {
            installBtn.remove(); // Supprime le bouton
            deferredPrompt.prompt(); // Ouvre le prompt d‚Äôinstallation

            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === "accepted") {
                console.log("L'utilisateur a install√© l'application");
              } else {
                console.log("L'utilisateur a refus√© l'installation");
              }
              deferredPrompt = null;
            });
          });
        });
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const scroller = document.querySelector("[data-scrollable]");
        if (!scroller) return;

        const updateShadows = () => {
          const maxScroll = scroller.scrollWidth - scroller.clientWidth;
          const atStart = scroller.scrollLeft <= 0;
          const atEnd = scroller.scrollLeft >= maxScroll - 1;

          scroller.classList.toggle("nav-scroll--shadow-left", !atStart);
          scroller.classList.toggle("nav-scroll--shadow-right", !atEnd);
        };

        updateShadows();
        scroller.addEventListener("scroll", updateShadows, { passive: true });
        window.addEventListener("resize", updateShadows);
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toggle = document.querySelector(".nav-search-toggle");
        const panel = document.querySelector(".nav-search-panel");
        const closeBtn = document.querySelector(".nav-search-close");
        const input = document.querySelector("#nav-search-input");

        if (!toggle || !panel || !closeBtn || !input) return;

        const openSearch = () => {
          panel.classList.add("nav-search-panel--open");
          toggle.setAttribute("aria-expanded", "true");
          window.setTimeout(() => input.focus(), 50);
        };

        const closeSearch = () => {
          panel.classList.remove("nav-search-panel--open");
          toggle.setAttribute("aria-expanded", "false");
          toggle.focus();
        };

        toggle.addEventListener("click", () => {
          if (panel.classList.contains("nav-search-panel--open")) {
            closeSearch();
          } else {
            openSearch();
          }
        });

        closeBtn.addEventListener("click", closeSearch);
        panel.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            event.preventDefault();
            closeSearch();
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("[data-carousel]").forEach((carousel) => {
          const track = carousel.querySelector("[data-carousel-track]");
          if (!track) return;

          const prev = carousel.querySelector(".carousel-btn--prev");
          const next = carousel.querySelector(".carousel-btn--next");
          const addBtn = track.querySelector("[data-carousel-add-btn]");
          
          // Debug: v√©rifier si le bouton existe
          if (!addBtn) {
            console.warn("Bouton '+' non trouv√© dans le carrousel", carousel);
          }

          const updateButtons = () => {
            const scrollLeft = track.scrollLeft;
            const scrollWidth = track.scrollWidth;
            const clientWidth = track.clientWidth;
            const maxScroll = scrollWidth - clientWidth;
            
            const atStart = scrollLeft <= 1;
            // V√©rifier si on est proche de la fin (marge de 10px pour g√©rer les arrondis et padding)
            const atEnd = scrollLeft + clientWidth >= scrollWidth - 10;
            
            // Mettre √† jour les boutons prev/next seulement s'ils existent
            if (prev && next) {
              prev.classList.toggle("is-visible", !atStart && maxScroll > 0);
              next.classList.toggle("is-visible", !atEnd && maxScroll > 0);
              prev.disabled = atStart;
              next.disabled = atEnd;
            }
            
            // Afficher le bouton "+" seulement quand on est √† la fin du carrousel
            if (addBtn) {
              // Afficher si on est √† la fin OU si le contenu ne d√©passe pas (pas besoin de scroll)
              if (atEnd || maxScroll <= 0) {
                addBtn.classList.add("is-visible");
              } else {
                addBtn.classList.remove("is-visible");
              }
            }
          };

          const scrollByAmount = () => {
            track.scrollBy({
              left: track.clientWidth * 0.8,
              behavior: "smooth",
            });
          };

          if (prev) {
            prev.addEventListener("click", () => {
              track.scrollBy({
                left: -track.clientWidth * 0.8,
                behavior: "smooth",
              });
            });
          }
          if (next) {
            next.addEventListener("click", () => {
              scrollByAmount();
              // R√©√©valuer apr√®s un court d√©lai pour g√©rer le scroll smooth
              setTimeout(() => {
                updateButtons();
                checkAddButtonVisibility();
              }, 300);
            });
          }

          // Fonction pour v√©rifier si le bouton "+" doit √™tre visible
          const checkAddButtonVisibility = () => {
            if (!addBtn) return;
            
            const scrollLeft = track.scrollLeft;
            const scrollWidth = track.scrollWidth;
            const clientWidth = track.clientWidth;
            const maxScroll = scrollWidth - clientWidth;
            
            // Si le contenu ne d√©passe pas, toujours afficher
            if (maxScroll <= 0) {
              addBtn.classList.add("is-visible");
              return;
            }
            
            // Calculer le pourcentage de scroll (0 = d√©but, 100 = fin)
            const scrollPercent = maxScroll > 0 ? (scrollLeft / maxScroll) * 100 : 0;
            
            // V√©rifier aussi avec une marge plus large pour √™tre s√ªr
            const remainingScroll = scrollWidth - (scrollLeft + clientWidth);
            const atEnd = remainingScroll <= 30 || scrollLeft + clientWidth >= scrollWidth - 5;
            
            // Afficher le bouton si on a scroll√© √† 80% ou plus, OU si on est vraiment √† la fin
            if (scrollPercent >= 80 || atEnd) {
              addBtn.classList.add("is-visible");
            } else {
              addBtn.classList.remove("is-visible");
            }
          };
          
          // R√©√©valuer apr√®s chaque scroll (avec debounce pour g√©rer les animations smooth)
          let scrollTimeout;
          track.addEventListener("scroll", () => {
            updateButtons(); // Mise √† jour imm√©diate
            checkAddButtonVisibility(); // V√©rifier la visibilit√© du bouton
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
              updateButtons();
              checkAddButtonVisibility();
            }, 150); // R√©√©valuation apr√®s animation
          }, { passive: true });
          
          window.addEventListener("resize", () => {
            updateButtons();
            checkAddButtonVisibility();
          });
          
          // Attendre un peu que le DOM soit compl√®tement rendu avant la premi√®re v√©rification
          setTimeout(() => {
            updateButtons();
            checkAddButtonVisibility();
          }, 100);
          updateButtons();
          checkAddButtonVisibility();
        });
      });
    </script>
  </body>
</html>
